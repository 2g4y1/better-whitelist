name: Releasename: Release



on:on:

  # Automatischer Release bei Push zu main (wenn Code geÃ¤ndert wurde)  push:

  push:    tags:

    branches:      - 'v*.*.*'

      - main  workflow_dispatch:

    paths:    inputs:

      - 'src/**'      version:

      - 'pom.xml'        description: 'Release version (e.g., v1.0.0)'

          required: true

  # Manueller Release mit Version-Tag        type: string

  push:

    tags:jobs:

      - 'v*.*.*'  release:

      runs-on: ubuntu-latest

  # Manueller Trigger    permissions:

  workflow_dispatch:      contents: write

    inputs:    

      version:    steps:

        description: 'Release version (e.g., v1.0.4)'    - name: Checkout code

        required: true      uses: actions/checkout@v4

        type: string      

      prerelease:    - name: Set up JDK 21

        description: 'Mark as pre-release'      uses: actions/setup-java@v4

        required: false      with:

        type: boolean        java-version: '21'

        default: false        distribution: 'temurin'

        cache: maven

concurrency:    

  group: release-${{ github.ref }}    - name: Cache Maven packages

  cancel-in-progress: true      uses: actions/cache@v4

      with:

jobs:        path: ~/.m2/repository

  release:        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}

    runs-on: ubuntu-latest        restore-keys: |

    permissions:          ${{ runner.os }}-maven-

      contents: write        

        - name: Build with Maven

    steps:      run: mvn clean package --batch-mode

    - name: Checkout code      

      uses: actions/checkout@v4    - name: Get commit info

      with:      id: commit

        fetch-depth: 0      run: echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

            

    - name: Set up JDK 21    - name: Get version

      uses: actions/setup-java@v4      id: version

      with:      run: |

        java-version: '21'        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then

        distribution: 'temurin'          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

        cache: maven        else

              echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Cache Maven packages        fi

      uses: actions/cache@v4    

      with:    - name: Get previous tag

        path: ~/.m2/repository      id: prev_tag

        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}      run: |

        restore-keys: |        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          ${{ runner.os }}-maven-        echo "PREV_TAG=$PREV_TAG" >> $GITHUB_OUTPUT

          

    - name: Determine release type    - name: Rename JAR with commit ID

      id: release_type      run: |

      run: |        mv target/better-whitelist-*.jar target/better-whitelist-${{ steps.version.outputs.VERSION }}-${{ steps.commit.outputs.SHORT_SHA }}.jar

        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then    

          echo "TYPE=manual" >> $GITHUB_OUTPUT    - name: Generate checksums

          echo "IS_PRERELEASE=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT      run: |

        elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then        cd target

          echo "TYPE=version_tag" >> $GITHUB_OUTPUT        sha256sum better-whitelist-*.jar > better-whitelist-${{ steps.version.outputs.VERSION }}-${{ steps.commit.outputs.SHORT_SHA }}.jar.sha256

          echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT        cat *.sha256

        else        

          echo "TYPE=auto" >> $GITHUB_OUTPUT    - name: Create Release

          echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT      uses: softprops/action-gh-release@v1

        fi      with:

            tag_name: ${{ steps.version.outputs.VERSION }}

    - name: Check if version tag exists on current commit        name: Release ${{ steps.version.outputs.VERSION }}

      id: version_tag_check        draft: false

      run: |        prerelease: false

        if git describe --exact-match --tags HEAD 2>/dev/null | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$'; then        generate_release_notes: true

          echo "HAS_VERSION_TAG=true" >> $GITHUB_OUTPUT        body: |

        else          ## ðŸ“¦ Installation

          echo "HAS_VERSION_TAG=false" >> $GITHUB_OUTPUT          Lade die `better-whitelist-${{ steps.version.outputs.VERSION }}-${{ steps.commit.outputs.SHORT_SHA }}.jar` herunter und kopiere sie in deinen `plugins` Ordner.

        fi          

              ## ðŸ” Checksumme

    - name: Skip if auto-release and version tag exists          ```

      if: steps.release_type.outputs.TYPE == 'auto' && steps.version_tag_check.outputs.HAS_VERSION_TAG == 'true'          SHA256: siehe .sha256 Datei im Download

      run: |          ```

        echo "â­ï¸ Ãœberspringe Auto-Release, da ein Version-Tag existiert"          

        exit 0          ---

                  

    - name: Build with Maven          **Commit-ID:** ${{ steps.commit.outputs.SHORT_SHA }}

      run: mvn clean package --batch-mode          

                ${{ steps.prev_tag.outputs.PREV_TAG && format('**Vergleich:** [{0}...{1}](https://github.com/{2}/compare/{0}...{1})', steps.prev_tag.outputs.PREV_TAG, steps.version.outputs.VERSION, github.repository) || '' }}

    - name: Get commit info        files: |

      id: commit          target/better-whitelist-${{ steps.version.outputs.VERSION }}-${{ steps.commit.outputs.SHORT_SHA }}.jar

      run: |          target/better-whitelist-${{ steps.version.outputs.VERSION }}-${{ steps.commit.outputs.SHORT_SHA }}.jar.sha256

        echo "COUNT=$(git rev-list --count HEAD)" >> $GITHUB_OUTPUT      env:

        echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      
    - name: Determine version
      id: version
      run: |
        if [[ "${{ steps.release_type.outputs.TYPE }}" == "manual" ]]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        elif [[ "${{ steps.release_type.outputs.TYPE }}" == "version_tag" ]]; then
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          # Auto-release: Build-Nummer
          echo "VERSION=v1.0.0-build.${{ steps.commit.outputs.COUNT }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Get previous tag
      id: prev_tag
      run: |
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        echo "PREV_TAG=$PREV_TAG" >> $GITHUB_OUTPUT
    
    - name: Check if tag already exists
      id: tag_exists
      run: |
        if git rev-parse "${{ steps.version.outputs.VERSION }}" >/dev/null 2>&1; then
          echo "EXISTS=true" >> $GITHUB_OUTPUT
        else
          echo "EXISTS=false" >> $GITHUB_OUTPUT
        fi
      
    - name: Rename JAR with version and commit ID
      if: steps.tag_exists.outputs.EXISTS == 'false'
      run: |
        mv target/better-whitelist-*.jar target/better-whitelist-${{ steps.version.outputs.VERSION }}-${{ steps.commit.outputs.SHORT_SHA }}.jar
    
    - name: Generate checksums
      if: steps.tag_exists.outputs.EXISTS == 'false'
      run: |
        cd target
        sha256sum better-whitelist-*.jar > better-whitelist-${{ steps.version.outputs.VERSION }}-${{ steps.commit.outputs.SHORT_SHA }}.jar.sha256
        echo "ðŸ“‹ Checksumme:"
        cat *.sha256
    
    - name: Determine release title and body
      if: steps.tag_exists.outputs.EXISTS == 'false'
      id: release_content
      run: |
        if [[ "${{ steps.release_type.outputs.TYPE }}" == "auto" ]]; then
          echo "TITLE=Auto Release ${{ steps.version.outputs.VERSION }}" >> $GITHUB_OUTPUT
          cat << 'EOF' > release_body.md
        Automatisches Release von Commit ${{ github.sha }}
        
        **Build-Datum:** $(date +'%Y.%m.%d')
        **Commit:** ${{ github.event.head_commit.message }}
        **Commit-ID:** ${{ steps.commit.outputs.SHORT_SHA }}
        
        Diese Version wurde automatisch erstellt und als Pre-Release markiert.
        EOF
        else
          echo "TITLE=Release ${{ steps.version.outputs.VERSION }}" >> $GITHUB_OUTPUT
          cat << 'EOF' > release_body.md
        ## ðŸ“¦ Installation
        Lade die `better-whitelist-${{ steps.version.outputs.VERSION }}-${{ steps.commit.outputs.SHORT_SHA }}.jar` herunter und kopiere sie in deinen `plugins` Ordner.
        
        ## ðŸ” Checksumme
        ```
        SHA256: siehe .sha256 Datei im Download
        ```
        
        ---
        
        **Commit-ID:** ${{ steps.commit.outputs.SHORT_SHA }}
        EOF
          
          if [[ -n "${{ steps.prev_tag.outputs.PREV_TAG }}" ]]; then
            echo "" >> release_body.md
            echo "**Vergleich:** [${{ steps.prev_tag.outputs.PREV_TAG }}...${{ steps.version.outputs.VERSION }}](https://github.com/${{ github.repository }}/compare/${{ steps.prev_tag.outputs.PREV_TAG }}...${{ steps.version.outputs.VERSION }})" >> release_body.md
          fi
        fi
        
    - name: Create Release
      if: steps.tag_exists.outputs.EXISTS == 'false'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: ${{ steps.release_content.outputs.TITLE }}
        draft: false
        prerelease: ${{ steps.release_type.outputs.IS_PRERELEASE }}
        generate_release_notes: true
        body_path: release_body.md
        files: |
          target/better-whitelist-${{ steps.version.outputs.VERSION }}-${{ steps.commit.outputs.SHORT_SHA }}.jar
          target/better-whitelist-${{ steps.version.outputs.VERSION }}-${{ steps.commit.outputs.SHORT_SHA }}.jar.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Release Summary
      if: steps.tag_exists.outputs.EXISTS == 'false'
      run: |
        echo "## ðŸŽ‰ Release erstellt!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "**Typ:** ${{ steps.release_type.outputs.TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "**Pre-Release:** ${{ steps.release_type.outputs.IS_PRERELEASE }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ steps.commit.outputs.SHORT_SHA }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "[ðŸ”— Zum Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION }})" >> $GITHUB_STEP_SUMMARY
